<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>O Eleito - Versão com "Próxima Pergunta"</title>
  <style>
    /* ======== ESTILOS GERAIS ======== */
    body {
      margin: 0;
      padding: 0;
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: #f0f0f3;
      color: #333;
    }
    header {
      background: #007BFF;
      color: #fff;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    .container {
      max-width: 980px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    h2, h3 {
      margin-top: 0;
    }
    .hidden {
      display: none !important;
    }

    /* Seções de host e player */
    #initialSection, #hostSection, #playerSection {
      margin-bottom: 20px;
    }
    #hostSection, #playerSection {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 20px;
      background: #fafafa;
      display: none; /* some até acionado */
    }
    hr {
      margin: 15px 0;
    }

    /* Botões */
    button {
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: background 0.2s;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Inputs */
    input[type="text"], select {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1rem;
      margin-right: 10px;
    }

    /* Lista de jogadores */
    .playerList {
      list-style: none;
      padding: 0;
    }
    .playerList li {
      margin: 5px 0;
    }

    /* QR Code */
    #qrCodeImg {
      margin: 10px 0;
      display: block;
      max-width: 200px;
    }

    /* Área da pergunta + curiosidade */
    #questionContainer {
      text-align: center;
      margin: 20px 0;
    }
    .curiosityText {
      font-style: italic;
      color: #555;
      margin-bottom: 10px;
    }
    .questionText {
      font-weight: bold;
      font-size: 1.2rem;
      color: #222;
    }

    /* Mensagens de resultado */
    .resultHighlight {
      color: #d9534f;
      font-weight: bold;
    }

    .rankingItem {
      margin: 5px 0;
    }

    /* Responsivo */
    @media (max-width: 600px) {
      .container {
        margin: 10px;
        padding: 10px;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>O Eleito - Jogo Interativo</h1>
</header>

<div class="container">
  <!-- Seção Inicial -->
  <div id="initialSection">
    <h2>Bem-vindo!</h2>
    <p>Escolha se você é o <strong>Host</strong> (organizador) ou <strong>Jogador</strong>:</p>
    <button id="btnHost">Sou o Host (Criar Sala)</button>
    <button id="btnPlayer">Sou um Jogador (Entrar em Sala)</button>
  </div>

  <!-- Seção do Host -->
  <div id="hostSection">
    <h2>Você é o Host</h2>

    <!-- Configurações da sala -->
    <div id="configSection">
      <h3>Configurar Nova Sala</h3>
      <label for="selectModo">Modo de Perguntas:</label>
      <select id="selectModo">
        <option value="normal">Normal</option>
        <option value="picante">Só Picantes</option>
        <option value="normalPicante">Normal + Picante</option>
      </select>

      <label for="selectBebida">Bebida?</label>
      <select id="selectBebida">
        <option value="com">Com Bebida</option>
        <option value="sem">Sem Bebida</option>
      </select>

      <label for="selectRodadas">Rodadas:</label>
      <select id="selectRodadas">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="15">15</option>
        <option value="20">20</option>
      </select>
      <br><br>
      <button id="btnCreateRoom">Criar Sala Agora</button>
    </div>

    <!-- Informações após a sala ser criada -->
    <div id="roomInfo" class="hidden">
      <p><strong>ID da Sala:</strong> <span id="roomIdLabel"></span></p>
      <p><strong>Link da Sala:</strong> <span id="roomLink"></span></p>
      <img id="qrCodeImg" alt="QR Code da sala" />
      <hr>
      <h3>Jogadores Conectados</h3>
      <ul id="connectedPlayers" class="playerList"></ul>
      <hr>
      <button id="btnStartGame" class="hidden">Iniciar Partida</button>
      <button id="btnEndGame" class="hidden">Encerrar Partida</button>

      <!-- Área do jogo em andamento -->
      <div id="gameArea" class="hidden">
        <h3>Rodada: <span id="roundCounter"></span> / <span id="totalRounds"></span></h3>

        <!-- Container central da curiosidade + pergunta -->
        <div id="questionContainer">
          <div class="curiosityText" id="curiosityText"></div>
          <div class="questionText" id="questionText"></div>
        </div>

        <p id="voteStatus"></p>
        <button id="btnReveal" class="hidden">Revelar Resultado</button>
        <button id="btnNextQuestion" class="hidden">Próxima Pergunta</button>
        <div id="resultArea"></div>
      </div>

      <!-- Área de fim de jogo -->
      <div id="endGameArea" class="hidden">
        <h3>Fim do Jogo!</h3>
        <div id="rankingArea"></div>
      </div>
    </div>
  </div>

  <!-- Seção do Jogador -->
  <div id="playerSection">
    <h2>Você é um Jogador</h2>
    <div id="playerRoomIdArea">
      <label>Sala ID: </label>
      <input type="text" id="inputRoomId" placeholder="Digite o ID da sala ou use ?room= no link">
      <button id="btnGoRoom">Entrar</button>
    </div>

    <div id="playerJoinArea" class="hidden">
      <h3>Entrar como jogador</h3>
      <input type="text" id="playerNameInput" placeholder="Seu nome">
      <button id="btnJoinPlayer">Participar</button>
    </div>

    <div id="playerGameArea" class="hidden">
      <h3>Sala: <span id="playerRoomIdLabel"></span></h3>
      <p>Olá, <span id="playerNameLabel"></span>!</p>

      <!-- Exibir curiosidade e pergunta também ao jogador -->
      <div id="playerQuestionContainer" style="text-align: center; margin: 20px 0;">
        <div class="curiosityText" id="playerCuriosityText"></div>
        <div class="questionText" id="playerQuestionText"></div>
      </div>

      <h4>Vote em quem você acha que se encaixa:</h4>
      <div id="voteOptions"></div>

      <!-- Exibir resultado aqui também -->
      <div id="playerResultArea" style="margin-top: 15px; color:#b00;"></div>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-database-compat.js"></script>

<script>
/************************************************************
 * 1) CONFIGURAR O FIREBASE COM SUAS CREDENCIAIS
 ************************************************************/

const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_PROJETO.firebaseapp.com",
  databaseURL: "https://SEU_PROJETO-default-rtdb.firebaseio.com/",
  projectId: "SEU_PROJETO",
  storageBucket: "SEU_PROJETO.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/************************************************************
 * 2) CONTADOR DE SALA (Sala_01, Sala_02...)
 ************************************************************/
function criarNovaSala() {
  return db.ref('salaCount').transaction((valorAtual) => {
    if (valorAtual === null) valorAtual = 0;
    return valorAtual + 1;
  }).then((result) => {
    const salaNum = result.snapshot.val();
    return "Sala_" + String(salaNum).padStart(2, '0');
  });
}

/************************************************************
 * 3) EXEMPLO DE PERGUNTAS (COM CURIOSIDADES)
 *    Para 300 perguntas, crie um array grande.
 ************************************************************/
const normalQuestions = [
  {
    question: "Quem você acha que escalaria o Everest sem pensar?",
    curiosity: "Curiosidade: O Monte Everest tem quase 9.000 metros de altitude."
  },
  {
    question: "Quem você acha que viraria meme da internet em dois segundos?",
    curiosity: "Sabia que mais de 70% dos memes surgem no Twitter?"
  }
];
const picanteQuestions = [
  {
    question: "Quem você acha que iria pra uma praia de nudismo sem hesitar?",
    curiosity: "Curiosidade: Praias de nudismo são populares na Europa."
  },
  {
    question: "Quem você acha que beijaria alguém aleatório numa festa?",
    curiosity: "Existem estudos que catalogam mais de 20 tipos de beijos!"
  }
];

/************************************************************
 * 4) ELEMENTOS DO DOM E VARIÁVEIS
 ************************************************************/
const initialSection = document.getElementById('initialSection');
const hostSection = document.getElementById('hostSection');
const playerSection = document.getElementById('playerSection');

// Host config
const selectModo = document.getElementById('selectModo');
const selectBebida = document.getElementById('selectBebida');
const selectRodadas = document.getElementById('selectRodadas');
const btnCreateRoom = document.getElementById('btnCreateRoom');
const roomInfo = document.getElementById('roomInfo');
const roomIdLabel = document.getElementById('roomIdLabel');
const roomLink = document.getElementById('roomLink');
const qrCodeImg = document.getElementById('qrCodeImg');
const connectedPlayers = document.getElementById('connectedPlayers');
const btnStartGame = document.getElementById('btnStartGame');
const btnEndGame = document.getElementById('btnEndGame');
const gameArea = document.getElementById('gameArea');
const voteStatus = document.getElementById('voteStatus');
const btnReveal = document.getElementById('btnReveal');
const btnNextQuestion = document.getElementById('btnNextQuestion');
const resultArea = document.getElementById('resultArea');
const endGameArea = document.getElementById('endGameArea');
const rankingArea = document.getElementById('rankingArea');
const roundCounter = document.getElementById('roundCounter');
const totalRounds = document.getElementById('totalRounds');
const curiosityText = document.getElementById('curiosityText');
const questionText = document.getElementById('questionText');

// Player
const inputRoomId = document.getElementById('inputRoomId');
const btnGoRoom = document.getElementById('btnGoRoom');
const playerJoinArea = document.getElementById('playerJoinArea');
const playerNameInput = document.getElementById('playerNameInput');
const btnJoinPlayer = document.getElementById('btnJoinPlayer');
const playerGameArea = document.getElementById('playerGameArea');
const playerRoomIdLabel = document.getElementById('playerRoomIdLabel');
const playerNameLabel = document.getElementById('playerNameLabel');
const playerCuriosityText = document.getElementById('playerCuriosityText');
const playerQuestionText = document.getElementById('playerQuestionText');
const voteOptions = document.getElementById('voteOptions');
const playerResultArea = document.getElementById('playerResultArea');

// Botões “Sou Host” e “Sou Player”
const btnHost = document.getElementById('btnHost');
const btnPlayer = document.getElementById('btnPlayer');
const playerRoomIdArea = document.getElementById('playerRoomIdArea');

// Variáveis
let globalRoomId = null;
let globalIsHost = false;
let globalPlayerId = null;
let globalPlayerName = "";
let globalModo = "normal";
let globalBebida = "com";
let globalNumRodadas = 5;
let globalRoundAtual = 0;
let playersRef = null;
let votesRef = null;
let salaRef = null;

// Pool de perguntas
let questionPool = [];
let usedQuestionIndexes = [];

/************************************************************
 * 5) Verifica se tem ?room=XXX no link
 ************************************************************/
const urlParams = new URLSearchParams(window.location.search);
const existingRoomParam = urlParams.get('room');
if (existingRoomParam) {
  // É jogador
  globalRoomId = existingRoomParam;
  showPlayerSection();
} else {
  // Se não tem, mostra menu inicial
  initialSection.style.display = "block";
}

/************************************************************
 * 6) Botões da tela inicial
 ************************************************************/
btnHost.onclick = () => {
  initialSection.style.display = "none";
  hostSection.style.display = "block";
};
btnPlayer.onclick = () => {
  initialSection.style.display = "none";
  playerSection.style.display = "block";
};

/************************************************************
 * 7) HOST: Criar Sala
 ************************************************************/
btnCreateRoom.onclick = async () => {
  globalModo = selectModo.value;
  globalBebida = selectBebida.value;
  globalNumRodadas = parseInt(selectRodadas.value);

  questionPool = buildQuestionPool(globalModo);
  usedQuestionIndexes = [];

  const salaGerada = await criarNovaSala(); // ex Sala_01
  globalRoomId = salaGerada;
  globalIsHost = true;

  salaRef = db.ref("salas/" + globalRoomId);
  playersRef = salaRef.child("players");
  votesRef = salaRef.child("votes");

  salaRef.set({
    modo: globalModo,
    bebida: globalBebida,
    numRodadas: globalNumRodadas,
    status: "waiting",
    currentQuestion: null,
    round: 0,
    lastResult: "",
    createdAt: Date.now()
  });

  roomInfo.classList.remove('hidden');
  roomIdLabel.textContent = globalRoomId;

  const fullLink = window.location.origin + window.location.pathname + "?room=" + globalRoomId;
  roomLink.textContent = fullLink;

  // Gera QR Code
  const qrApi = "https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=" + encodeURIComponent(fullLink);
  qrCodeImg.src = qrApi;

  // Escuta jogadores
  playersRef.on("value", (snap) => {
    const data = snap.val() || {};
    renderPlayerList(data);
  });

  // Se o lastResult mudar, atualiza resultArea
  salaRef.child("lastResult").on("value", (snap) => {
    const txt = snap.val() || "";
    if (txt !== "") {
      resultArea.innerHTML = txt;
    }
  });

  document.getElementById('configSection').classList.add('hidden');
  btnStartGame.classList.remove('hidden');
  btnEndGame.classList.remove('hidden');
};

/** Lista de jogadores no Host */
function renderPlayerList(playersObj) {
  connectedPlayers.innerHTML = "";
  Object.keys(playersObj).forEach(pid => {
    const li = document.createElement('li');
    li.textContent = playersObj[pid].name;
    connectedPlayers.appendChild(li);
  });
}

/************************************************************
 * 8) Iniciar Partida (Host)
 ************************************************************/
btnStartGame.onclick = () => {
  salaRef.update({
    status: "inProgress",
    round: 1
  });
  globalRoundAtual = 1;
  btnStartGame.classList.add('hidden');
  gameArea.classList.remove('hidden');
  endGameArea.classList.add('hidden');
  totalRounds.textContent = globalNumRodadas.toString();
  roundCounter.textContent = globalRoundAtual.toString();

  startNewRound();
};

/** Encerrar Partida Manual (Host) */
btnEndGame.onclick = () => {
  finalizeGame();
};

/************************************************************
 * 9) Sortear Pergunta (Host)
 ************************************************************/
function startNewRound() {
  votesRef.set({});
  resultArea.innerHTML = "";
  salaRef.child("lastResult").set("");
  btnReveal.classList.remove('hidden');
  btnNextQuestion.classList.add('hidden');
  voteStatus.textContent = "Aguardando votos...";

  const idx = getUniqueRandomIndex();
  const objPerg = questionPool[idx];
  curiosityText.textContent = objPerg.curiosity;
  questionText.textContent = objPerg.question;

  salaRef.update({
    currentQuestion: objPerg
  });
}

/** Sorteio de índice único */
function getUniqueRandomIndex() {
  if (usedQuestionIndexes.length >= questionPool.length) {
    return Math.floor(Math.random() * questionPool.length);
  }
  let idx = Math.floor(Math.random() * questionPool.length);
  while (usedQuestionIndexes.includes(idx)) {
    idx = Math.floor(Math.random() * questionPool.length);
  }
  usedQuestionIndexes.push(idx);
  return idx;
}

/************************************************************
 * 10) Revelar Resultado (Host)
 ************************************************************/
btnReveal.onclick = async () => {
  const snap = await votesRef.once('value');
  const votesData = snap.val() || {};

  const count = {};
  Object.keys(votesData).forEach(voterId => {
    const chosen = votesData[voterId];
    count[chosen] = (count[chosen] || 0) + 1;
  });

  let eleitoId = null;
  let maxVotes = 0;
  Object.keys(count).forEach(pid => {
    if (count[pid] > maxVotes) {
      maxVotes = count[pid];
      eleitoId = pid;
    }
  });

  if (!eleitoId) {
    const msg = "<p>Ninguém recebeu voto ainda!</p>";
    resultArea.innerHTML = msg;
    salaRef.child("lastResult").set(msg);
    // Depois que revela, permite "Próxima Pergunta"
    btnReveal.classList.add('hidden');
    btnNextQuestion.classList.remove('hidden');
    return;
  }

  // Pegar nome do eleito
  const playersSnap = await playersRef.once('value');
  const playersData = playersSnap.val() || {};
  const eleitoName = playersData[eleitoId] ? playersData[eleitoId].name : "Desconhecido";

  let msg = `O Eleito é <span class="resultHighlight">${eleitoName}</span> com ${count[eleitoId]} voto(s)!`;
  if (globalBebida === "com") {
    msg += `<br><strong>${eleitoName}, beba seu drink!</strong>`;
  }
  resultArea.innerHTML = msg;
  salaRef.child("lastResult").set(msg);

  // Atualiza pontuação
  const currScore = playersData[eleitoId].score || 0;
  playersRef.child(eleitoId).update({ score: currScore + 1 });

  // Oculta "Revelar" e mostra "Próxima Pergunta"
  btnReveal.classList.add('hidden');
  btnNextQuestion.classList.remove('hidden');
};

/************************************************************
 * 11) Botão "Próxima Pergunta"
 ************************************************************/
btnNextQuestion.onclick = () => {
  // Verifica se ainda há rodadas
  if (globalRoundAtual < globalNumRodadas) {
    globalRoundAtual++;
    roundCounter.textContent = globalRoundAtual.toString();
    startNewRound();
  } else {
    finalizeGame();
  }
};

/************************************************************
 * 12) Finalizar Partida
 ************************************************************/
async function finalizeGame() {
  voteStatus.textContent = "";
  gameArea.classList.add('hidden');
  btnReveal.classList.add('hidden');
  btnNextQuestion.classList.add('hidden');
  btnStartGame.classList.add('hidden');
  btnEndGame.classList.add('hidden');

  endGameArea.classList.remove('hidden');
  salaRef.update({ status: 'finished' });

  const snap = await playersRef.once('value');
  const data = snap.val() || {};
  const arr = Object.keys(data).map(pid => {
    return { name: data[pid].name, score: data[pid].score || 0 };
  });
  arr.sort((a,b) => b.score - a.score);

  let html = "<h4>Ranking Final</h4>";
  arr.forEach((p, i) => {
    html += `<div class="rankingItem"><strong>${i+1}º</strong> - ${p.name}: ${p.score} votos</div>`;
  });
  rankingArea.innerHTML = html;
}

/************************************************************
 * 13) Montar Pool de Perguntas
 ************************************************************/
function buildQuestionPool(modo) {
  switch(modo) {
    case "normal":
      return [...normalQuestions];
    case "picante":
      return [...picanteQuestions];
    case "normalPicante":
      return [...normalQuestions, ...picanteQuestions];
    default:
      return [...normalQuestions];
  }
}

/************************************************************
 * 14) MODO JOGADOR
 ************************************************************/
function showPlayerSection() {
  initialSection.style.display = 'none';
  hostSection.style.display = 'none';
  playerSection.style.display = 'block';
}

/** Entrar na sala digitando ID */
btnGoRoom.onclick = () => {
  const rid = inputRoomId.value.trim();
  if (!rid) {
    alert("Digite o ID da sala (ex.: Sala_01)");
    return;
  }
  globalRoomId = rid;
  playerRoomIdArea.classList.add('hidden');
  playerJoinArea.classList.remove('hidden');
};

/** Se veio via ?room=, pula direto */
if (existingRoomParam) {
  playerRoomIdArea.classList.add('hidden');
  playerJoinArea.classList.remove('hidden');
}

/** Botão "Participar" (Jogador) */
btnJoinPlayer.onclick = async () => {
  const name = playerNameInput.value.trim();
  if (!name) {
    alert("Digite seu nome!");
    return;
  }
  globalPlayerName = name;

  salaRef = db.ref("salas/" + globalRoomId);
  playersRef = salaRef.child("players");
  votesRef = salaRef.child("votes");

  const newPlayerRef = playersRef.push();
  globalPlayerId = newPlayerRef.key;
  await newPlayerRef.set({
    name: globalPlayerName,
    score: 0
  });

  // Escuta a pergunta atual
  salaRef.child("currentQuestion").on('value', (snap) => {
    const val = snap.val();
    if (val) {
      playerCuriosityText.textContent = val.curiosity;
      playerQuestionText.textContent = val.question;
    } else {
      playerCuriosityText.textContent = "";
      playerQuestionText.textContent = "(Aguardando início...)";
    }
  });

  // Escuta lastResult
  salaRef.child("lastResult").on('value', (snap) => {
    const txt = snap.val() || "";
    playerResultArea.innerHTML = txt;
  });

  // Escuta status
  salaRef.child("status").on('value', (snap) => {
    if (snap.val() === "finished") {
      voteOptions.innerHTML = "<p>O jogo terminou!</p>";
    }
  });

  // Escuta players pra montar botões de voto
  playersRef.on('value', (snap) => {
    const data = snap.val() || {};
    renderVoteOptions(data);
  });

  playerJoinArea.classList.add('hidden');
  playerGameArea.classList.remove('hidden');
  playerRoomIdLabel.textContent = globalRoomId;
  playerNameLabel.textContent = globalPlayerName;
};

/** Monta botões de voto */
function renderVoteOptions(playersObj) {
  voteOptions.innerHTML = "";
  Object.keys(playersObj).forEach((pid) => {
    if (pid === globalPlayerId) return;
    const btn = document.createElement('button');
    btn.textContent = playersObj[pid].name;
    btn.onclick = () => castVote(pid);
    voteOptions.appendChild(btn);
  });
}

function castVote(targetPid) {
  votesRef.child(globalPlayerId).set(targetPid)
    .then(() => {
      alert("Voto computado!");
    })
    .catch(err => console.error(err));
}
</script>
</body>
</html>
